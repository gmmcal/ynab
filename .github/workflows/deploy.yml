name: Deploy

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  tag:
    name: "Tag: Production"
    uses: gmmcal/gmmcal-reusable-workflows/.github/workflows/_tag.yml@v1
    concurrency:
      group: tag
      cancel-in-progress: false
    with:
      reference: ${{ github.sha }}

  release:
    name: Release
    uses: gmmcal/gmmcal-reusable-workflows/.github/workflows/_release.yml@v1
    needs:
      - tag
    with:
      tag: ${{needs.tag.outputs.version}}
      reference: ${{ github.sha }}

  build_production:
    name: Build
    uses: gmmcal/gmmcal-reusable-workflows/.github/workflows/_docker.yml@v1
    needs:
      - tag
      - release
    secrets:
      dockerhub-username: ${{ secrets.DOCKERHUB_USERNAME }}
      dockerhub-token: ${{ secrets.DOCKERHUB_TOKEN }}
    with:
      name: Production
      target: production
      reference: ${{needs.tag.outputs.version}}
      image: "gmmcal/ynab:${{needs.tag.outputs.version}},gmmcal/ynab:production"

  build_development:
    name: Build
    uses: gmmcal/gmmcal-reusable-workflows/.github/workflows/_docker.yml@v1
    secrets:
      dockerhub-username: ${{ secrets.DOCKERHUB_USERNAME }}
      dockerhub-token: ${{ secrets.DOCKERHUB_TOKEN }}
    concurrency:
      group: build-development
      cancel-in-progress: true
    with:
      name: Development
      target: development
      image: "gmmcal/ynab:development"
